<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goldstine研究所 &middot; Goldstine研究所</title>

    <meta name="description" content="mosuke5&#39;s blog">

    <meta name="generator" content="Hugo 0.14" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Goldstine研究所 &middot; Goldstine研究所">
    <meta name="twitter:description" content="mosuke5&#39;s blog">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Goldstine研究所 &middot; Goldstine研究所">
    <meta property="og:description" content="mosuke5&#39;s blog">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">

    <link rel="stylesheet" href="https://blog.mosuke.tech/css/all.min.css">
    <link rel="stylesheet" href="https://blog.mosuke.tech/css/mosuke5.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="Goldstine研究所" href="https://blog.mosuke.tech/index.xml" />
    <link rel="icon" type="image/png" href="/image/favicon.png">
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="https://blog.mosuke.tech">Goldstine研究所</a></h1>
            <h2 class="brand-tagline"> mosuke5&#39;s blog </h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                
                <h1 class="content-subhead">13 Aug 2015, 00:04</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.mosuke.tech/entry/2015/08/13/000440/" class="post-title">デスクトップUbuntuにVNC接続。ついでにSSHローカルポートフォワードの復習。</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Ubuntu" href="https://blog.mosuke.tech/categories/ubuntu">Ubuntu</a><a class="post-category post-category-vnc" href="https://blog.mosuke.tech/categories/vnc">vnc</a><a class="post-category post-category-ポートフォワード" href="https://blog.mosuke.tech/categories/%E3%83%9D%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%AF%E3%83%BC%E3%83%89">ポートフォワード</a><a class="post-category post-category-SSH" href="https://blog.mosuke.tech/categories/ssh">SSH</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p>完全に自分のための備忘録。内容はわりと薄め。</p></p>

<h1>やったこと</h1>

<p>最近、自作したPCに<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>をいれて使っているのだけど、<br>
デスクトップPCなので、部屋でしか操作することができません。</p>

<p>他の部屋からノートPCで<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>を触れたらいいなーと思いその環境を整えることをしました。</p>

<p>主にやったことは以下の通りです。</p>

<ul>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/VNC">VNC</a>サーバ構築について</li>
<li>ノートPC（<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mac">Mac</a>）からの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VNC">VNC</a>接続について</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>ローカルポートフォワードを使ってのセキュアな接続について</li>
</ul>

<h1>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>での<a class="keyword" href="http://d.hatena.ne.jp/keyword/VNC">VNC</a>サーバ構築について</h1>

<p>今回利用している<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>は「<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> Desktop 14.04」です。<br>
また、<a class="keyword" href="http://d.hatena.ne.jp/keyword/VNC">VNC</a>の実現は標準でインストールされているvinoを使って行いました。</p>

<p>ご存知の方も多くいるかもしれませんが、vinoでの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VNC">VNC</a>は簡易的なもので、サーバ側のユーザがログアウトしていると使えません。<br>
ですので、会社などでの利用には耐えないと思います。<br>
ユーザーをログアウトせずにロック状態にしていれば使えます。</p>

<p>まずはデスクトップ共有の設定をします。<br>
「デスクトップの共有」のアプリケーションを起動します。
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150809/20150809132410.png" alt="f:id:mosuke5:20150809132410p:plain" title="f:id:mosuke5:20150809132410p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>接続毎に要求するようにすると、サーバ側で毎度許可が必要なので、オフにします。<br>
パスワードの設定はしておきましょう。<br>
同じLANをつかんでる人に簡単に奪われてしまいますので。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150809/20150809132421.png" alt="f:id:mosuke5:20150809132421p:plain" title="f:id:mosuke5:20150809132421p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>ちょっと詳細な意味を把握していないのですが、<br>
下記を実行しないと<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mac">Mac</a>で接続すると「互換性のないバージョンです」的なこといわれました…すいません。</p>

<pre><code>$ gsettings set org.gnome.Vino require-encryption false 

</code></pre>

<p>設定ができたら、きちんとサーバとして<a class="keyword" href="http://d.hatena.ne.jp/keyword/VNC">VNC</a>接続を待ち受けているか確認します。</p>

<pre><code>% sudo lsof -i:5900
COMMAND     PID    USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
vino-serv 24414 mosuke5   13u  IPv6 156661      0t0  TCP *:5900 (LISTEN)
vino-serv 24414 mosuke5   14u  IPv4 156662      0t0  TCP *:5900 (LISTEN)

% ps -ef | grep vino
mosuke5  24414 24226  0 12:30 ?        00:00:21 /usr/lib/vino/vino-server --sm-disable
mosuke5  25456 24470  0 13:19 pts/11   00:00:00 grep vino 
</code></pre>

<h1>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mac">Mac</a>から<a class="keyword" href="http://d.hatena.ne.jp/keyword/VNC">VNC</a>接続する</h1>

<p>これをやるまで知らなかったのですが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mac">Mac</a>には標準で<a class="keyword" href="http://d.hatena.ne.jp/keyword/VNC">VNC</a>クライアントがついています。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/vnc">vnc</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%ED%A5%C8%A5%B3%A5%EB">プロトコル</a>で対象のサーバの<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>を入れれば接続できます。
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150812/20150812225515.png" alt="f:id:mosuke5:20150812225515p:plain" title="f:id:mosuke5:20150812225515p:plain" class="hatena-fotolife" itemprop="image"></span>
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150812/20150812225126.png" alt="f:id:mosuke5:20150812225126p:plain" title="f:id:mosuke5:20150812225126p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h1>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>ローカルフォワードを使ってセキュアな通信をする</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/VNC">VNC</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%ED%A5%C8%A5%B3%A5%EB">プロトコル</a>は通信の内容を暗号化しません。<a class="keyword" href="http://d.hatena.ne.jp/keyword/telnet">telnet</a>と同様で、非常に危険です。<br>
家のLAN内で利用するので、正直ここまでする必要は全くないのだが、<br>
より応用的な使い方に備えてと、復習を兼ねて<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のローカルフォワードを利用してセキュアに<a class="keyword" href="http://d.hatena.ne.jp/keyword/VNC">VNC</a>を使ってみます。</p>

<p>復習と書いたのは以前に、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のローカルフォワードについてはまとめたからです。</p>
<a href="/entry/2014/12/31/170545/">SSHでローカルポートフォワードを実際に試す - Goldstine研究所</a>

<p>まずは、ローカルフォワードの<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>接続。<br>
意味は「自分の端末のポート8888に来た通信は、192.168.11.5からみて<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>のポート5900にとばします」です。</p>

<pre><code>$ ssh -L8888:localhost:5900 mosuke5@192.168.11.5 
</code></pre>

<p>上のコマンドで<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>接続した状態でなら、<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>のポート8888が利用できます。
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150812/20150812224539.png" alt="f:id:mosuke5:20150812224539p:plain" title="f:id:mosuke5:20150812224539p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p><p>これでセキュアな<a class="keyword" href="http://d.hatena.ne.jp/keyword/VNC">VNC</a>の完成。</p>
</body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">31 Jul 2015, 21:15</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.mosuke.tech/entry/2015/07/31/211542/" class="post-title">Packerやる前にKickstartはじめよう</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Linux" href="https://blog.mosuke.tech/categories/linux">Linux</a><a class="post-category post-category-kickstart" href="https://blog.mosuke.tech/categories/kickstart">kickstart</a><a class="post-category post-category-virtualbox" href="https://blog.mosuke.tech/categories/virtualbox">virtualbox</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<h1>1.はじめに</h1></p>

<p>開発環境はVirualboxを使った<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vagrant">Vagrant</a>を利用しているが、<br>
本番環境は<a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a>だったり<a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>だったり違う仮想化機構で動作しているなんてことよくあると思います。<br>
そういう環境下でどのように開発環境と本番環境の差分をなくしていますか？</p>

<p>わたしの場合、基本的にAnsibleを使ってプロビジョニングをしていますが、<br>
そのプロビジョニング前のベースが異なってしまって困ることがよくあります。<br>
一般に公開されているVagrantBox使ったら余計な設定が入っていたとか、すでにパッケージが入っていたとか…</p>

<p>そんな問題を解決しようとPackerを使おう！って考えました。<br>
ですが、Packerも当たり前だけど魔法ではなく、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Kickstart">Kickstart</a>などの自動インストールが前提なので、<br>
Packerをやる前に<a class="keyword" href="http://d.hatena.ne.jp/keyword/Kickstart">Kickstart</a>を学習せよ、、、ということに気づきました。</p>

<p>ということで<a class="keyword" href="http://d.hatena.ne.jp/keyword/Kickstart">Kickstart</a>をはじめたよってことです。</p>

<h1>2.<a class="keyword" href="http://d.hatena.ne.jp/keyword/kickstart">kickstart</a>ってなに</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/kickstart">kickstart</a>はOSのインストールを自動化する仕組みです。<br>
anaconda社が提供するインストールの仕組みで<a class="keyword" href="http://d.hatena.ne.jp/keyword/Redhat">Redhat</a>系のOSが採用しているものです。<br>
ですので<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>だとPreseedっていう別の仕組みだそうです。（詳しくありませんっ）</p>

<p>で、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Kickstart">Kickstart</a>でなにができるかというと...</p>

<p>OSのインストールをしたことがある方ならわかるかと思いますが、<br>
普通にDVDなどからインストールすると、</p>

<ul>
<li>言語はなににしますかー？</li>
<li>ホスト名なににしますかー？</li>
<li>パッケージはなにをいれますかー？</li>
</ul>

<p>とか、聞かれて選択していく必要があります。
この作業を自動化できるのが<a class="keyword" href="http://d.hatena.ne.jp/keyword/kickstart">kickstart</a>です。</p>

<p>URLのようなもの。
<iframe src="//hatenablog-parts.com/embed?url=http%3A%2F%2Fkajuhome.com%2Fcentos6_inst.shtml" title="はじめての自宅サーバ構築 - Fedora/CentOS - CentOS6 のインストール手順" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"><a href="http://kajuhome.com/centos6_inst.shtml">はじめての自宅サーバ構築 - Fedora/CentOS - CentOS6 のインストール手順</a></iframe><cite class="hatena-citation"><a href="http://kajuhome.com/centos6_inst.shtml">kajuhome.com</a></cite></p>

<h1>(おまけ)Ansible, Chef, Puppetとの違い？</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/kickstart">kickstart</a>にはプロビジョニング機能もついているため、<br>
AnsibleとかChefとかPuppetとの違いは？住み分けは？と思うかもしれません。<br>
明確に、住み分けが決まっているわけではありませんが、
個人的にはAnsibleやChefを実行する前の最低限の設定を<a class="keyword" href="http://d.hatena.ne.jp/keyword/kickstart">kickstart</a>にやらせようと思っています。<br>
（一般的かとは思いますが…？）</p>

<p>Lee ThompsonのProvisioning Toolchainを参考にKiskstarのやる範囲をまとめると。
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150731/20150731223953.jpg" alt="f:id:mosuke5:20150731223953j:plain" title="f:id:mosuke5:20150731223953j:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p><iframe src="//hatenablog-parts.com/embed?url=http%3A%2F%2Fen.oreilly.com%2Fvelocity-mar2010%2Fpublic%2Fschedule%2Fdetail%2F14180" title="Provisioning Toolchain: Web Performance and Operations - Velocity Online Conference - March 17, 2010 - O'Reilly Media" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"><a href="http://en.oreilly.com/velocity-mar2010/public/schedule/detail/14180">Provisioning Toolchain: Web Performance and Operations - Velocity Online Conference - March 17, 2010 - O'Reilly Media</a></iframe><cite class="hatena-citation"><a href="http://en.oreilly.com/velocity-mar2010/public/schedule/detail/14180">en.oreilly.com</a></cite></p>

<h1>3.Hello <a class="keyword" href="http://d.hatena.ne.jp/keyword/Kickstart">Kickstart</a>!!</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Virtualbox">Virtualbox</a>を使って<a class="keyword" href="http://d.hatena.ne.jp/keyword/Kickstart">Kickstart</a>を試しました。</p>

<h1>3-1.用意したもの</h1>

<ul>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Virtualbox">Virtualbox</a>

<ul>
<li>自分の環境は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mac">Mac</a>で、バージョンは5.0</li>
</ul>
</li>
<li>OSのisoファイル

<ul>
<li>
<a href="http://isoredirect.centos.org/centos/7/isos/x86_64/CentOS-7-x86_64-DVD-1503-01.iso">CentOS Mirror</a> ここからダウンロードしました</li>
</ul>
</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/kickstart">kickstart</a>ファイル

<ul>
<li>ネットワーク上においてhttpでアクセスできるようにしておきました</li>
</ul>
</li>
</ul>

<p>利用した<a class="keyword" href="http://d.hatena.ne.jp/keyword/kickstart">kickstart</a>ファイル。自分の学習のためコメントを多く残しました。</p>

<pre><code># アップグレードするかインストールするか
install

# インストールタイプの設定
# CD-ROM経由かネットワーク経由かとか
cdrom

# 言語設定
lang ja_JP.UTF-8

# キーボード設定
keyboard jp106

# ネットワーク設定
# /etc/sysconfig/network-scripts/ifcfg-xxxx 部分
network --onboot yes --device eth0 --bootproto dhcp --noipv6

# rootのパスワード
# xxxxxx部分はopensslコマンドで作成するといい
# $openssl passwd -1
rootpw --iscrypted xxxxxxxxxxxxxxxxxxxxxxxxxxx

# iptablesの設定
# プロビジョニングで設定するのでここでは無効にしておく
firewall --disabled

# 認証オプション
authconfig --enableshadow --passalgo=sha512

# SELinuxの設定
# こちらも詳細はプロビジョニングで設定するので無効にしておく
selinux --disabled

# タイムゾーン
timezone --utc Asia/Tokyo

# ブートローダのインストール方法
bootloader --location=mbr --driveorder=sda --append=&quot;nomodeset crashkernel=auto rhgb quiet&quot;

# 設定後にリブート
reboot

# パーティション設定
clearpart --linux --drives=sda
autopart

# インストールパッケージ選択
%packages --nobase
@core

%end 
</code></pre>

<h3>参考になったもの</h3>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Redhat">Redhat</a>社のインストールガイドがよくまとまっていた。<br>
特に<a class="keyword" href="http://d.hatena.ne.jp/keyword/kickstart">kickstart</a>ファイルについては下記あたりが役立ちます。</p>

<ul>
<li><a href="https://access.redhat.com/documentation/ja-JP/Red_Hat_Enterprise_Linux/6/html/Installation_Guide/s1-kickstart2-options.html">32.4. キックスタートのオプション</a></li>
<li><a href="https://access.redhat.com/documentation/ja-JP/Red_Hat_Enterprise_Linux/6/html/Installation_Guide/s1-kickstart2-packageselection.html">32.5. パッケージの選択</a></li>
</ul>

<h1>3-2.<a class="keyword" href="http://d.hatena.ne.jp/keyword/kickstart">kickstart</a>ファイルの使い方</h1>

<p>しかし、OSインストール前なのにどうやってファイルを使うのか…？<br>
はじめ戸惑いました…</p>

<p>実は以下の方法で利用できます。</p>

<p>OSのisoファイルで起動するとこの画面がでるやろ。
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150802/20150802125544.png" alt="f:id:mosuke5:20150802125544p:plain" title="f:id:mosuke5:20150802125544p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>そして、ここでTabをおすと、なにか入力できるが画面が出てきて。<br>
そこに、<a class="keyword" href="http://d.hatena.ne.jp/keyword/kickstart">kickstart</a>ファイルのパスを入力してやる。
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150802/20150802125630.png" alt="f:id:mosuke5:20150802125630p:plain" title="f:id:mosuke5:20150802125630p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>これで<a class="keyword" href="http://d.hatena.ne.jp/keyword/Kickstart">Kickstart</a>完了や。</p>

<h1>4.最後に</h1>

<p><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Kickstart">Kickstart</a>入門したし、次はPackerをやりたいと思います。<br>
が、ふと思ったのが、自分の用途だとPackerではなく<a class="keyword" href="http://d.hatena.ne.jp/keyword/Kickstart">Kickstart</a>で十分かもなーとか思ったり思わなかったり…</p>
</body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">19 Jul 2015, 13:58</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.mosuke.tech/entry/2015/07/19/135844/" class="post-title">DockerとWebSocketを使って、vimの設定をブラウザで即体感できるサービスを作った</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-vim" href="https://blog.mosuke.tech/categories/vim">vim</a><a class="post-category post-category-vim::factory" href="https://blog.mosuke.tech/categories/vimfactory">vim::factory</a><a class="post-category post-category-vimfactory" href="https://blog.mosuke.tech/categories/vimfactory">vimfactory</a><a class="post-category post-category-docker" href="https://blog.mosuke.tech/categories/docker">docker</a><a class="post-category post-category-websocket" href="https://blog.mosuke.tech/categories/websocket">websocket</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p>2014年の秋から<code>@mogulla3</code>と定期的にインフラ関連技術の勉強会をやってきましたが、<br>
インプットの勉強会だけでは飽き足らず、いつしかサービスを作る中でインフラ関連技術を駆使し勉強したいと思うように…</p></p>

<p>そして、普段使っている<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を題材に、<br>
<b><span style="font-size: 150%"><a class="keyword" href="http://d.hatena.ne.jp/keyword/vim">vim</a>の設定をブラウザ上で即体感できるサービス <a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factory</span></b><br>
を開発しました。</p>

<p>本記事は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryの簡単な紹介と技術的な仕組みについて記述しています。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryはこちら。<br>
<a href="http://vimfactory.com/">http://vimfactory.com/</a></p>

<h1>1. <a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryについて</h1>

<h2>1-1. <a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryってなに？？</h2>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryは、選択した<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>の設定を、ブラウザ上で「即体感」できるサービスです。<br>
数多くあり複雑な<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>の設定を容易にし、お気に入りの<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>探しをサポートすることを目指しています。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150719/20150719155723.png" alt="f:id:mosuke5:20150719155723p:plain" title="f:id:mosuke5:20150719155723p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h2>1-2. なんで作ったの？</h2>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>の設定ってたくさんあってどれを選んでいいかわからなかったり、<br>
設定したもののどう変わったかイマイチわからなかったりしませんか？</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>の設定がどのように反映されるか、もっと簡単に体験したいと考えたからです。</p>

<p>あと、例えば<a class="keyword" href="http://d.hatena.ne.jp/keyword/Github">Github</a>で100star以上をつける人の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>をブラウザ上で体験できたらいいなと思っていて、<br>
それを実現のための第一歩としてこのサービスを作りました。</p>

<h2>1-3. このサービスの最大の特徴は？</h2>

<p>このサービスの最大の特徴はなんといっても<b>「ブラウザ上で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>が体感できること」</b>です。</p>

<p>今までは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>の設定を試そうと思ったら、ネットで調べて自分の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>に反映させて…という作業が必要でしたが、<br>
ブラウザ上で設定を即体感するという新しい体験を提供するために力を注いできました。<br>
その実現方法については、後述しています。</p>

<h2>1-4. 紹介動画</h2>

<p>詳しくは、実際に試してもらうのが早いと思いますが、簡単な操作動画を用意してみました。<br>
モバイルからこのサービスはちょっと使えないので、モバイルで読んでいる方は動画でお楽しみください(笑)<br>
<iframe width="480" height="270" src="https://www.youtube.com/embed/j20agcBcAec?feature=oembed" frameborder="0" allowfullscreen></iframe><cite class="hatena-citation"><a href="https://www.youtube.com/watch?v=j20agcBcAec&amp;feature=youtu.be">www.youtube.com</a></cite></p>

<h1>2. <a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryの技術について</h1>

<p>ここから<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryの技術について一部ではありますがご紹介します。</p>

<h2>2-1. ブラウザ上での<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を実現した技術</h2>

<p>ブラウザ上で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を実現しようと思うと、ぱっと思いつくのは<a class="keyword" href="http://d.hatena.ne.jp/keyword/JavaScript">JavaScript</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>そのものを実装してしまおうというものかもしれません。<br>
ですが、JSで<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を実装することってどれくらい難しいでしょうか？<br>
少なくともぼくにはそんなことはできませんし、できたとして質の悪いものになってしまうと思います。</p>

<p>そこで思いついたのが、一般的なターミナルソフトと同様にサーバ上で<a class="keyword" href="http://d.hatena.ne.jp/keyword/vim">vim</a>を起動し、<br>
そのターミナル情報をブラウザ上で表示するという方法です。<br>
この方法であれば自ら<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を実装せずとも<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を再現できます。イメージは下記のとおりです。<br>
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150718/20150718230605.png" alt="f:id:mosuke5:20150718230605p:plain" title="f:id:mosuke5:20150718230605p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>また、サービスとして上記を行うには、接続してきたユーザごとに<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を用意する必要があります。</p>

<p>これらを実現するために利用したのが<b>Docker</b>と<b>WebSocket</b>です。<br>
dockerコンテナ上で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を起動し、そのターミナル情報をWebSocketでブラウザに送信するようにしました。
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150720/20150720002840.png" alt="f:id:mosuke5:20150720002840p:plain" title="f:id:mosuke5:20150720002840p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>dockerはコンテナ型の仮想化なので起動がとてもはやく、<br>
httpのリクエストが来てからdockerコンテナを立ち上げても十分なほどのはやさをもっています。</p>

<h2>2-2. 全体構成</h2>

<p>システムの全体構成は以下のような感じです。<br>
※実際の役割は図のとおりですが、サーバはこんなに多くありません。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150719/20150719124021.png" alt="f:id:mosuke5:20150719124021p:plain" title="f:id:mosuke5:20150719124021p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h2>2-3. 利用した技術とか<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C4%A1%BC%A5%EB">ツール</a>のまとめ</h2>

<p>振り返りも兼ねて利用した技術・<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C4%A1%BC%A5%EB">ツール</a>を一覧にまとめておきます。</p>

<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a></li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Sinatra">Sinatra</a></li>
<li>thin</li>
<li>node.js</li>
<li>Websocket</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/memcached">memcached</a></li>
<li>docker</li>
<li>nginx</li>
<li>centos7</li>
<li>Ansible</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Vagrant">Vagrant</a></li>
<li>gitlab</li>
<li>mackerel</li>
<li>slack</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/esa">esa</a>.io(ドキュメント管理)</li>
</ul>

<h1>3. まとめ</h1>

<p>このサービスで一番苦労したことはやっぱりブラウザ上での<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>の実現部分です。<br>
当初、このサービスを思いついた時、実現不可能だ…とあきらめました。<br>
というのもJS（アプリケーションサイド）で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>をどう実装しようかしか考えていなかったからです。</p>

<p>ですが、ふとしたときに上記の別の方法（インフラサイド）での実現方法を思いつきました。</p>

<p>このサービスを作るきっかけは、インフラ技術のインプット勉強だけでは飽きたらず、<br>
サービスを開発・運用していくなかでインフラ技術を磨いていきたいというものでしたが、<br>
インプットの勉強があってこそインフラサイドからの実現方法を見つけられたようにも思いました。</p>

<p>今後、運用を通してさらなるパワーアップができたらいいなと思います。</p>

<h1>4. 最後に</h1>

<p>最後になりますが、
完全な趣味で作ってしまったサービスで、今後どのように展開していこうか何も考えていません。<br>
まずは、このように公開し皆様に利用して頂いて、フィードバックなど頂いてから考えようと思っています。</p>

<p>サービスに関するご意見等あれば、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Twitter">Twitter</a>やメールで書いてくれると大変嬉しいです。</p>

<p>お問い合せはこちら:</p>

<ul>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Twitter">Twitter</a>: <a href="https://twitter.com/mosuke5">もーすけ (@mosuke5) | Twitter</a> or <a href="https://twitter.com/mogulla3">もぐらマン (@mogulla3) | Twitter</a>
</li>
<li>e-mail: ilab.vimfactory+info@<a class="keyword" href="http://d.hatena.ne.jp/keyword/gmail">gmail</a>.com</li>
</ul>

<p>では、みなさんも<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>ライフを楽しみましょう！</p>

<p><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryはこちら。<br>
<a href="http://vimfactory.com/">http://vimfactory.com/</a></p>
</body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">17 Jun 2015, 21:28</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.mosuke.tech/entry/2015/06/17/212852/" class="post-title">PostgreSQL環境でFuelPHPのDBマイグレーションを使う</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-php" href="https://blog.mosuke.tech/categories/php">php</a><a class="post-category post-category-fuelphp" href="https://blog.mosuke.tech/categories/fuelphp">fuelphp</a><a class="post-category post-category-DBマイグレーション" href="https://blog.mosuke.tech/categories/db%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3">DBマイグレーション</a><a class="post-category post-category-PostgreSQL" href="https://blog.mosuke.tech/categories/postgresql">PostgreSQL</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p>今更<a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>感はあるのだが、<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/postgresql">postgresql</a>利用時の<a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>のmigration導入について、注意点をまとめた。<br>
でも、結論は納得がいっていない。</p></p>

<h1>0. 前提</h1>

<p>下記の環境で行ったものです。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>: 5.5.7<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>: 1.7<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Postgresql">Postgresql</a>: 9.4</p>

<h1>1. テーブル<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%B8%BB%FA%A5%B3%A1%BC%A5%C9">文字コード</a>の問題</h1>

<h1><a class="keyword" href="http://d.hatena.ne.jp/keyword/%BB%F6%BE%DD">事象</a></h1>

<p>公式サイトのサンプルの通りはじめに<code>app/migrations/001_example.php</code>を作り、migrationを実行した。</p>

<p><code>app/migrations/001_example.php</code>の作成</p>

<pre><code class="language-php">&lt;?php
namespace Fuel\Migrations;
class Example
{
    function up()
    {
        \DBUtil::create_table('posts', array(
            'id' =&gt; array('type' =&gt; 'int', 'constraint' =&gt; 5),
            'title' =&gt; array('type' =&gt; 'varchar', 'constraint' =&gt; 100),
            'body' =&gt; array('type' =&gt; 'text'),
        ), array('id'));
    }
    
    function down()
    {
        \DBUtil::drop_table('posts');
    }
}
</code></pre>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a>実行すると以下のエラーに襲われた。</p>

<pre><code>$ php oil refine migrate
Uncaught exception Fuel\Core\Database_Exception: SQLSTATE[42601]: Syntax error: 7 ERROR: syntax error at or near &quot;DEFAULT&quot;
LINE 5: )DEFAULT CHARACTER SET utf8;
^ with query: &quot;CREATE TABLE IF NOT EXISTS &quot;migration&quot; (
&quot;type&quot; varchar(25) NOT NULL,
&quot;name&quot; varchar(50) NOT NULL,
&quot;migration&quot; varchar(100) DEFAULT '' NOT NULL
)DEFAULT CHARACTER SET utf8;&quot; 

</code></pre>

<h1>理由</h1>

<p>しょっぱなから躓くわけだが…</p>

<p>初めて<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a>を実行する際には<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a>管理用のテーブルを作る。<br>
そのテーブルを作る<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>が下記の通り発行されている。</p>

<pre><code class="language-sql">CREATE TABLE IF NOT EXISTS &quot;migration&quot; (
&quot;type&quot; varchar(25) NOT NULL,
&quot;name&quot; varchar(50) NOT NULL,
&quot;migration&quot; varchar(100) DEFAULT '' NOT NULL
)DEFAULT CHARACTER SET utf8;
</code></pre>

<p>理由は単純で、<a class="keyword" href="http://d.hatena.ne.jp/keyword/postgresql">postgresql</a>のcreate tableでは次のdefault構文は利用できないから。</p>

<pre><code class="language-sql">create table xxxx ( ) default character set xxx;
</code></pre>

<p>なぜ、利用できない構文の<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>が発行されたのか？<br>
それは単に<a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>の問題です。次期バージョンでは解決されることを祈る。</p>

<h1>解決方法</h1>

<p>解決方法は下記の記事がわかりやすかった。
<iframe src="//hatenablog-parts.com/embed?url=http%3A%2F%2Fqiita.com%2Fhirobow%2Fitems%2F8c2c379b33f0040480b7" title="FuelPHP で PDOによるPostgreSQL接続の罠 - Qiita" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"><a href="http://qiita.com/hirobow/items/8c2c379b33f0040480b7">FuelPHP で PDOによるPostgreSQL接続の罠 - Qiita</a></iframe><cite class="hatena-citation"><a href="http://qiita.com/hirobow/items/8c2c379b33f0040480b7">qiita.com</a></cite></p>

<p>簡単に言うとdbのコンフィグで、charsetをnullにすると<code>DEFAULT CHARACTER SET xxx</code>部分が発行されない。</p>

<pre><code>'charset' =&gt; NULL, 

</code></pre>

<h1>2. PRIMARY KEYの問題</h1>

<h1><a class="keyword" href="http://d.hatena.ne.jp/keyword/%BB%F6%BE%DD">事象</a></h1>

<p>1.の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%B8%BB%FA%A5%B3%A1%BC%A5%C9">文字コード</a>の問題は解決して、さあもう一度<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a>を！と思って実行するもさらなるエラーに阻まれる。</p>

<pre><code>$ php oil refine migrate
Uncaught exception Fuel\Core\Database_Exception: SQLSTATE[42601]: Syntax error: 7 ERROR: syntax error at or near &quot;(&quot;
LINE 2: &quot;id&quot; int(5) NOT NULL,
^ with query: &quot;CREATE TABLE IF NOT EXISTS &quot;users&quot; (
&quot;id&quot; int(5) NOT NULL,
&quot;name&quot; text NOT NULL,
PRIMARY KEY &quot;id&quot; (&quot;id&quot;)
);&quot; 
</code></pre>

<p>理由は1のときと一緒。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/postgresql">postgresql</a>では以下の構文は使えないのだ…</p>

<pre><code>PRIMARY KEY &quot;id&quot; (&quot;id&quot;) 
</code></pre>

<h1>3. 結局</h1>

<p>つまるところ<a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>(すくなくとも1.7までは)では、<a class="keyword" href="http://d.hatena.ne.jp/keyword/postgresql">postgresql</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a>を行う環境がちゃんと整っていないということ。<br>
しかたないので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>は生<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>を書くことにしました。</p>

<p>PRIMARY KEYを後から別途で付与するとか考えたけど、<br>
ほかにも罠がありそうだったので、安全な生<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>を採用しました。<br>
バージョン1.8では直っている?とのことだが、まだdevelopmentだったのでこれも見送り。</p>

<p>うむ。。。</p>

<p><p>&lt;参考&gt;
<iframe src="//hatenablog-parts.com/embed?url=http%3A%2F%2Fimprove-future.com%2Favailable-dbms-in-fuelphp.html" title="FuelPHP で使用可能なデータベース" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"><a href="http://improve-future.com/available-dbms-in-fuelphp.html">FuelPHP で使用可能なデータベース</a></iframe><cite class="hatena-citation"><a href="http://improve-future.com/available-dbms-in-fuelphp.html">improve-future.com</a></cite></p>
</body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">13 Jun 2015, 23:19</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.mosuke.tech/entry/2015/06/13/231917/" class="post-title">Ajaxの嫌いだった部分をJsRenderで心地良くした</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-javascript" href="https://blog.mosuke.tech/categories/javascript">javascript</a><a class="post-category post-category-JsRender" href="https://blog.mosuke.tech/categories/jsrender">JsRender</a><a class="post-category post-category-ajax" href="https://blog.mosuke.tech/categories/ajax">ajax</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<h1>1. はじめに</h1></p>

<p>ぼくはフロントエンドは本業ではありません。<br>
jsはあまり好きではありません。<br>
そして<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ajax">Ajax</a>通信後にhtmlをアウトプットする際にjsの変数の中にhtmlを書いていく<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>がもっと好きではありません。(後述)<br>
それをJSテンプレートエンジンを使ってシンプルにしてみたって話です。
（JsRenderの使い方を書いたものではありません。）</p>

<h1>2. <a class="keyword" href="http://d.hatena.ne.jp/keyword/Ajax">Ajax</a>が嫌いだった理由</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ajax">Ajax</a>はユーザ体感的にはいいのだけれど、<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ajax">Ajax</a>の結果受け取った<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>などのデータを使ってhtmlを出力とかやると<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>が煩雑になるので嫌いだった。</p>

<p>例として<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ajax">Ajax</a>で/xxxxxにリクエストを投げて、その結果(<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>データ)を使ってhtmlを出力するものを考えると。</p>

<pre><code class="language-javascript">/* jsonデータは下記が返ってくるとする
[
    {
        id: '1',
        name: 'らーめん',
        text: 'らーめんはやっぱり濃厚鶏そばです。'
    },
    {
        id: '2',
        name: 'うどん',
        text: 'うどんはやっぱり釜揚げうどんです。'
    }
]
*/
$.ajax({
  type: &quot;GET&quot;,
  url: &quot;/xxxxx&quot;,
  dataType: &quot;json&quot;,
  success: function(data){
    var html = '';
    data.forEach(function (e) {
      html += '&lt;div id=&quot;' + e.id + '&quot;&gt;';
      html += '&lt;h1&gt;' + e.name + '&lt;/h1&gt;';
      html += '&lt;p&gt;' + e.text + '&lt;/p&gt;';
      html += '&lt;/div&gt;';
    });
    $(&quot;#result&quot;).append(html);
  },
})

</code></pre>

<p>jsの変数の中にhtmlが含まれる。<br>
<b>そう、jsの変数の中にhtmlが！！</b><br>
この規模ならまだいいが、もう少しhtmlが肥大化してくると最悪である。<br>
これがどうしても許せない。</p>

<h1>3.jsのテンプレートエンジンを使ってみた</h1>

<p>上の問題をなんとかできないかと思っていたところ、jsのテンプレートエンジンにいきついた。<br>
jsのテンプレートエンジンは多数あるのだが今回はJsRenderを採用し、<a class="keyword" href="http://d.hatena.ne.jp/keyword/ajax">ajax</a>を心地よく使うことができるようになった。</p>

<p><a href="http://www.jsviews.com/">JsRender/JsViews</a></p>

<h3>3-1. jsテンプレートエンジンの選定について</h3>

<p>以下のまとめなど参考にするといいが、多数ある。
<iframe src="//hatenablog-parts.com/embed?url=http%3A%2F%2Fqiita.com%2FKumamon%2Fitems%2F7db7c8f5e5ace3b40874" title="JavaScriptテンプレートエンジンまとめ - Qiita" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"><a href="http://qiita.com/Kumamon/items/7db7c8f5e5ace3b40874">JavaScriptテンプレートエンジンまとめ - Qiita</a></iframe><cite class="hatena-citation"><a href="http://qiita.com/Kumamon/items/7db7c8f5e5ace3b40874">qiita.com</a></cite></p>

<p>用途としては下記のような感じで選んだ。</p>

<ul>
<li>クライアントサイドで利用できる

<ul>
<li>特にサーバサイドで使える必要はなかった</li>
</ul>
</li>
<li>簡単に利用できること。学習コストが低そうなこと</li>
<li>for文やif文はつかえること</li>
<li>プレ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%F3%A5%D1%A5%A4%A5%EB">コンパイル</a>とかは必要なかった</li>
</ul>

<h3>3-2. JsRenderを使えばここまで<a class="keyword" href="http://d.hatena.ne.jp/keyword/ajax">ajax</a>がシンプルになった</h3>

<p>JsRenderを利用して先ほどの<a class="keyword" href="http://d.hatena.ne.jp/keyword/ajax">ajax</a>部分を書き直すと以下のようになる。</p>

<h4>js側</h4>

<pre><code class="language-javascript">$.ajax({
  type: &quot;GET&quot;,
  url: &quot;/xxxxx&quot;,
  dataType: &quot;json&quot;,
  success: function(data){
    var template = $.templates(&quot;#result-template&quot;);   // テンプレートを指定
    var htmlOutput = template.render(data);   //テンプレート内に変数展開
    $(&quot;#result&quot;).html(htmlOutput);   //出力
  },
})
</code></pre>

<h4>html側</h4>

<pre><code class="language-html">&lt;div id=&quot;result&quot;&gt;&lt;/div&gt;
&lt;script id=&quot;result-template&quot; type=&quot;text/x-jsrender&quot;&gt;
&lt;div id=&quot;{{:id}}&quot;&gt;
  &lt;h1&gt;{{:name}}&lt;/h1&gt;
  &lt;p&gt;{{:text}}&lt;/p&gt;
&lt;/div&gt;
&lt;/script&gt;
</code></pre>

<p>何が素晴らしいって、ロジックの部分と、ビュー部分を綺麗に分離できたこと。<br>
いや、サーバサイドなら当たり前のようにやっていたことなんだけど、<br>
JsRenderを使えばクライアントサイドでも簡単に実装できて最高でした。</p>

<p><p>以上。</p>
</body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">24 May 2015, 22:02</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.mosuke.tech/entry/2015/05/24/220226/" class="post-title">他人の家のインターネットを環境を整えて分かった無線LANルータのこと</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-ネットワーク" href="https://blog.mosuke.tech/categories/%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF">ネットワーク</a><a class="post-category post-category-無線LANルーター" href="https://blog.mosuke.tech/categories/%E7%84%A1%E7%B7%9Alan%E3%83%AB%E3%83%BC%E3%82%BF%E3%83%BC">無線LANルーター</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p>他人の家のインターネットを環境を整えて分かった<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a>ルータのことがあったのでまとめる。</p></p>

<p>我が家のインターネット環境は以下のような構成になっている。
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150524/20150524215405.png" alt="f:id:mosuke5:20150524215405p:plain" title="f:id:mosuke5:20150524215405p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>この構成では<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a>ルータは<b>L3とL2の両方</b>の機器として働いている。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B0%A5%ED%A1%BC%A5%D0%A5%EBIP">グローバルIP</a>とプライベートIPの両方を持っており、<br>
プライベートIPからの通信をグローバル側へルーティングする機能と、<br>
LAN内の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>の端末に接続する機能として。</p>

<p>一方、この前、他の人の家のインターネット環境を整えたのだが、<br>
以下のような構成だった。
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150524/20150524214832.png" alt="f:id:mosuke5:20150524214832p:plain" title="f:id:mosuke5:20150524214832p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>１つめの構成と決定的に違うところは、<a class="keyword" href="http://d.hatena.ne.jp/keyword/VDSL">VDSL</a>モデムにルータ機能もついていること。
この場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A1%BC%A5%BF%A1%BC">ルーター</a>はL2の機器として働いている。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A1%BC%A5%BF%A1%BC">ルーター</a>自体には<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>はなく、<a class="keyword" href="http://d.hatena.ne.jp/keyword/DHCP">DHCP</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>管理を行っているのも上位のルータだ。</p>

<p>この構成になるときは、一般的に光<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%C5%C5%CF%C3">IP電話</a>を利用するケースのようだ。<br>
というのも、一般的な<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A1%BC%A5%BF%A1%BC">ルーター</a>には光<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%C5%C5%CF%C3">IP電話</a>につなぐことができず、<br>
通信会社から貸与されるモデムルータを利用するため。</p>

<p>余談だが、今家では実は下記のような構成にしている。<br>
というのも、家の構造上、<a class="keyword" href="http://d.hatena.ne.jp/keyword/VDSL">VDSL</a>がでているところが納戸のようなところで、<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A1%BC%A5%BF%A1%BC">ルーター</a>を設置しても壁が多すぎるために電波が弱くなってしまう。<br>
そのため、リビング側へ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A1%BC%A5%BF%A1%BC">ルーター</a>を設置したかったからだ。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150524/20150524215424.png" alt="f:id:mosuke5:20150524215424p:plain" title="f:id:mosuke5:20150524215424p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p><p>とても単純な話だが、<br>
いろんなケースの家庭内インターネットの設定をすることで、<br>
いろいろと気づくこともあった。</p>
</body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">08 May 2015, 17:47</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.mosuke.tech/entry/2015/05/08/174732/" class="post-title">sinatra-assetpackをproduction環境で使う時にはまったー</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-ruby" href="https://blog.mosuke.tech/categories/ruby">ruby</a><a class="post-category post-category-sinatra" href="https://blog.mosuke.tech/categories/sinatra">sinatra</a><a class="post-category post-category-sinatra-assetpack" href="https://blog.mosuke.tech/categories/sinatra-assetpack">sinatra-assetpack</a><a class="post-category post-category-jsminify" href="https://blog.mosuke.tech/categories/jsminify">jsminify</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Sinatra">Sinatra</a>アプリケーションで、JSファイルを圧縮する<a class="keyword" href="http://d.hatena.ne.jp/keyword/sinatra">sinatra</a>-assetpackを利用していて、<br>
production環境で動作させようとしたら動かなくなってしまった問題について調査した。</p></p>

<h1>起こったこと</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Sinatra">Sinatra</a>を使ってアプリケーションを作っていて、development環境で完成したので、
prorudction環境で動作させようとしたら、jsのエラーが出るようになってしまい、正常に動かなくなった。</p>

<p>アクセスすると、以下のエラーがでる。要は<a class="keyword" href="http://d.hatena.ne.jp/keyword/jquery">jquery</a>がないとのこと。</p>

<pre><code>Uncaught ReferenceError: $ is not defined 
</code></pre>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/jQuery">jQuery</a>はもちろん読み込ませてるし、なんでproduction環境でだけ？？？</p>

<h1><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a></h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sinatra">sinatra</a>のメインアプリケーションであるapp.rbには以下のように、<a class="keyword" href="http://d.hatena.ne.jp/keyword/sinatra">sinatra</a>-assetpackを利用してjsを読み込んでいる。</p>

<pre><code class="language-ruby">assets do
  serve '/js', from: 'public/js'
  serve '/bower_components', from: 'bower_components'

  js :app, '/js/app.js', [
    '/js/index.js',
  ]

  js :libs, '/js/libs.js', [
    '/bower_components/jquery/dist/jquery.js',
    '/bower_components/bootstrap/dist/js/bootstrap.js',
  ]

  js_compression :jsmin
end

</code></pre>

<p>layout.erbにはもちろん、libs.jsが先に来るように記述している。</p>

<pre><code class="language-ruby">&lt;%= js :libs %&gt;
&lt;%= js :app %&gt;
</code></pre>

<h1>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/sinatra">sinatra</a>-assetpackの挙動</h1>

<p>productionでのみ発生する<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BB%F6%BE%DD">事象</a>なので、改めて<a class="keyword" href="http://d.hatena.ne.jp/keyword/sinatra">sinatra</a>-assetpackのproduction環境時の挙動を確認した。<br>
production環境では、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>のjsファイルを1つのファイルにまとめ、圧縮を行う。</p>

<h4>development環境</h4>

<p>３つのjsファイルがあったら以下のように３つ別々に読み込まれる。</p>

<pre><code class="language-html">&lt;script type='text/javascript' src='/js/vendor/jquery.283479.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/js/vendor/underscore.589491.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/js/app/main.589491.js'&gt;&lt;/script&gt;
</code></pre>

<h4>production環境</h4>

<p>３つあったjsファイルは1つにまとめられ、また圧縮される。</p>

<pre><code class="language-html">&lt;script type='text/javascript' src='/js/app.589491.js'&gt;&lt;/script&gt;
</code></pre>

<p>詳細はこちら<br>
<a href="https://github.com/rstacruz/sinatra-assetpack#results">rstacruz/sinatra-assetpack · GitHub</a></p>

<h1>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BB%F6%BE%DD">事象</a>の理由</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Chrome">Chrome</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%D0%A5%C3%A5%B0">デバッグ</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C4%A1%BC%A5%EB">ツール</a>のNetworkでファイルのダウンロード状況を確認してみると意外なことがわかった。
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150508/20150508171833.png" alt="f:id:mosuke5:20150508171833p:plain" title="f:id:mosuke5:20150508171833p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>画像が小さくて見づらいかもしれないが、
5行目と6行目のapp.jsとlibs.jsで先にlibs.jsを読み込んでいるのに、おそらく圧縮とダウンロードに時間がかかり、<br>
app.jsのほうが先にダウンロードが終わっている。</p>

<p>libs.jsには<a class="keyword" href="http://d.hatena.ne.jp/keyword/jQuery">jQuery</a>などが含まれていて、app.js内で<a class="keyword" href="http://d.hatena.ne.jp/keyword/jQuery">jQuery</a>を利用する。<br>
よって、先にapp.jsが読み込まれてしまったことで、<a class="keyword" href="http://d.hatena.ne.jp/keyword/jQuery">jQuery</a>がねーぞ！と怒られてしまったのである。</p>

<h1>対策と考慮</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sinatra">sinatra</a>-assetpackなどを利用して、jsを圧縮する際には、
ファイルを1つにまとめたり圧縮したりする時間がかかることを十分に考慮しなければいけない。</p>

<p>あまり賢い手段をは言えないが、libs.jsとapp.jsひとつにまとめることで今回の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BB%F6%BE%DD">事象</a>は避けられる。
app.rb</p>

<pre><code class="language-ruby">assets do
  serve '/js', from: 'public/js'
  serve '/bower_components', from: 'bower_components'

  js :app, '/js/app.js', [
    '/bower_components/jquery/dist/jquery.js',
    '/bower_components/bootstrap/dist/js/bootstrap.js',
    '/js/index.js',
  ]

  js_compression :jsmin
end
</code></pre>

<p><p>また、事前に圧縮しておいて、ダウンロードだけする状態にしてもいいかもしれない。<br>
<a href="https://github.com/rstacruz/sinatra-assetpack#precompile">rstacruz/sinatra-assetpack · GitHub</a></p>
</body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">15 Apr 2015, 17:11</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.mosuke.tech/entry/2015/04/15/171127/" class="post-title">Ansibleで最新のMySQLをインストールする際にハマったこと。MySQL-shared-compatのこと。</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Ansible" href="https://blog.mosuke.tech/categories/ansible">Ansible</a><a class="post-category post-category-Linux" href="https://blog.mosuke.tech/categories/linux">Linux</a><a class="post-category post-category-MySQL" href="https://blog.mosuke.tech/categories/mysql">MySQL</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a> 6.5環境でAnsibleを使って最新の<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>のセットアップをしようと思った際にハマったことをまとめた。<br>
本質的にはAnsibleというより<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/RPM">RPM</a>パッケージのはなし。<br>
ついでに、しょっぼい<a class="keyword" href="http://d.hatena.ne.jp/keyword/github">github</a>を公開しました。</p></p>

<h1>(1) 本記事を書くに至った経緯</h1>

<ol>
<li>Ansibleで<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>を使ったサーバを構築(CentOS6.5)することになった。

<ul>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>のバージョンは5.6を採用した。</li>
</ul>
</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>の公式<a class="keyword" href="http://d.hatena.ne.jp/keyword/rpm">rpm</a>をダウンロードしインストールした。

<ul>
<li>インストールしたもの：<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-client, <a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-devel, <a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-server, <a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-shared</li>
</ul>
</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-sharedをインストールする際にデフォルトの<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>-libsと競合</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>-libsをアンインストールし再インストール</li>
<li>Ansibleで<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>の操作をするには<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL-python">MySQL-python</a>が必要なのでインストール</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL-python">MySQL-python</a>をインストールするにはさっきアンインストールした<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>-libsが必要…(困った)</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-shared-compatの存在に気づく</li>
<li>備忘録に書いておくか…</li>
</ol>

<h1>(2) <a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-shared-compatの存在</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>-libsは多くのパッケージの依存となっており、公式のMySQL5.6をインストールすることで、<br>
他のパッケージがいれられない状況となっていた。<br>
そんな状況を解決するために<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-shared-compatというパッケージが用意されていた。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-shared-compatは「過去の<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>バージョン向けの共有クライアントライブラリが納められているもの」だ。</p>

<p>詳細は下記参照をおすすめ。<br>
<a href="http://y-ken.hatenablog.com/entry/inside-of-libmysqlclient-with-mysql-shared-compat">MySQL-5.5.6から仕様が変わった「MySQL-shared-compat」の中身を徹底解剖 - Y-Ken Studio</a></p>

<p>ちなみに"compat"という単語がよく使われるが"compatibility"の略で「互換性」とかそういう意味。</p>

<h1>(3) <a class="keyword" href="http://d.hatena.ne.jp/keyword/Github">Github</a>で公開しました</h1>

<p>内容は今のところ死ぬほど薄いのだが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>をインストールするansibleを公開しました。
<a href="https://github.com/mosuke5/mysql-ansible">mosuke5/mysql-ansible · GitHub</a></p>

<p>内容はあれだが、特徴としては、インターネット上から<a class="keyword" href="http://d.hatena.ne.jp/keyword/RPM">RPM</a>をダウンロードしてインストールする際に、<br>
Ansibleでも「ダウンロード」→「インストール」の流れを踏む人が多いが、以下のようにするとシンプルになる。<br>
varsでインストールしたい<a class="keyword" href="http://d.hatena.ne.jp/keyword/rpm">rpm</a>やその取得先を記述しておいて、task側では<a class="keyword" href="http://d.hatena.ne.jp/keyword/yum">yum</a>でnameにvarsで定義した変数を読むだけでできる。</p>

<p>role/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>/vars/main.yml</p>

<pre><code class="language-yaml">mysql_url: http://ftp.jaist.ac.jp/pub/mysql/Downloads/MySQL-5.6
mysql_ver: &quot;5.6.24-1&quot;
mysql_rpms:
  - MySQL-client-{{ mysql_ver }}.el6.x86_64.rpm
  - MySQL-shared-compat-{{ mysql_ver }}.el6.x86_64.rpm
  - MySQL-shared-{{ mysql_ver }}.el6.x86_64.rpm
  - MySQL-devel-{{ mysql_ver }}.el6.x86_64.rpm
  - MySQL-server-{{ mysql_ver }}.el6.x86_64.rpm
 
</code></pre>

<p>role/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>/tasks/main.yml</p>

<pre><code class="language-yaml">- name: Install MySQL without MySQL-shared
  yum: name={{ mysql_url}}/{{ item }}
  with_items: mysql_rpms
 
</code></pre>

<p></body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">05 Apr 2015, 21:25</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.mosuke.tech/entry/2015/04/05/212518/" class="post-title">SSHエージェントフォワード後に他のユーザでgit cloneする(鍵を使う)ことに関する考察</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-CentOS7" href="https://blog.mosuke.tech/categories/centos7">CentOS7</a><a class="post-category post-category-SSH" href="https://blog.mosuke.tech/categories/ssh">SSH</a><a class="post-category post-category-エージェントフォワード" href="https://blog.mosuke.tech/categories/%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%83%95%E3%82%A9%E3%83%AF%E3%83%BC%E3%83%89">エージェントフォワード</a><a class="post-category post-category-sudo" href="https://blog.mosuke.tech/categories/sudo">sudo</a><a class="post-category post-category-Linux" href="https://blog.mosuke.tech/categories/linux">Linux</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のエージェントフォワードした後に、接続したユーザとは別のユーザでgit cloneしたいことがあった。<br>
それについて調べていく中で学習したことや検討したことについてまとめた。</p></p>

<h1>0. 前提</h1>

<p>ローカルのPC(<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mac">Mac</a>)上で、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vagrant">Vagrant</a>を使用してCentOS7の仮想サーバ(testsv)を立ち上げている。</p>

<p>&lt;<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>&gt;<br>
ローカルPC：192.168.33.1<br>
仮想サーバ：192.168.33.100</p>

<p>本記事上での「git cloneする」とは、「プライベートのGit<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%DD%A5%B8%A5%C8%A5%EA">レポジトリ</a>から<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>を利用してクローンする」ということを指す。</p>

<h1>1. <a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のエージェントフォワードを利用したい理由</h1>

<p>まず、そもそもなぜ<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のエージェントフォワードをする必要があったのか。<br>
最近では多くの方がご存知かつ利用していることだと思うが、仮想のサーバ上でgitを利用するときによく利用する。<br>
(もちろんそれだけの用途ではありません)</p>

<p>仮想サーバを作るたびに<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>の鍵を生成して、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Github">Github</a>等に登録するのが手間なので、<br>
ローカルのPCの鍵を他のサーバへ引き継ぐことでgit clone等を可能にするのだ。</p>

<h1>2. <a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>エージェントフォワード利用時の挙動</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のエージェントフォワードで利用される認証情報は、接続先サーバの/tmp以下に保存されます。</p>

<pre><code>[myuser@localpc ~]$ ssh -A vagrant@192.168.33.100
Last login: Sat Apr  4 xx:xx:xx 2015 from 192.168.33.1
[vagrant@testsv ~]$
[vagrant@testsv ~]$ ls -l /tmp | grep ssh
drwx------. 2 vagrant    vagrant    23  4月  4 11:35 ssh-skQVHsUCHU 

</code></pre>

<p><br>
また、接続ユーザには<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>_AUTH_SOCKという<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>ができ、どの認証情報を利用するか記述がされます。<br>
実際に確認してみる。<br>
確認方法は、envコマンドで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>一覧を表示し、そのなかで"<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>"を含むものを<a class="keyword" href="http://d.hatena.ne.jp/keyword/grep">grep</a>。</p>

<pre><code>[vagrant@testsv ~]$ env | grep -i ssh
SSH_AUTH_SOCK=/tmp/ssh-skQVHsUCHU/agent.9034
SSH_CLIENT='192.168.33.1 58017 22'
SSH_CONNECTION='192.168.33.1 58017 192.168.33.100 22'
SSH_TTY=/dev/pts/0 
</code></pre>

<p><br>
ちなみにエージェントフォワードは、認証エージェントに登録されている<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C8%EB%CC%A9%B8%B0">秘密鍵</a>を<br>
ログイン先のサーバから利用できるようにする機能であり、接続元自体が変わるわけではない。<br>
試しにエージェントフォワードで接続したサーバ先から、更に<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>をして、その接続状況をみてみる。</p>

<pre><code>[myuser@localpc ~]$ ssh -A vagrant@192.168.33.100
Last login: Sat Apr  4 xx:xx:xx 2015 from 192.168.33.1
[vagrant@testsv ~]$ ssh -A vagrant@192.168.33.100
Last login: Sat Apr  4 xx:xx:xx 2015 from 192.168.33.1
[vagrant@testsv ~]$
[vagrant@testsv ~]$ w
 11:50:17 up  1:55,  2 users,  load average: 0.00, 0.01, 0.05
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
vagrant  pts/0    192.168.33.1     11:35    1.00s  0.04s  0.01s ssh -A vagrant@192.168.33.100
vagrant  pts/1    192.168.33.100   11:50    1.00s  0.01s  0.00s w 

</code></pre>

<p>wコマンドの結果の3行目のFROMをみるとわかるが、接続元が変わるわけではない。</p>

<h1>3. <a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>エージェントフォワードで接続後にrootユーザでgit cloneする</h1>

<p>例えば、rootでしかアクセスできないディレクトリにgit cloneしたいと思い、<br>
以下のようにsudoをつけてgit cloneしてみる。</p>

<pre><code>[vagrant@testsv ~]$ sudo git clone git@xxxxx.xxx:yyyy/zzzzzz.git /root/hoge
Permission denied (publickey).
fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists. 
</code></pre>

<p>sudoをつけてgit cloneしようとすると、エージェントフォワードしたのにアクセス権がありませんと言われてしまった。<br>
なぜエージェントフォワードしたのにgit cloneできないのだろうか？</p>

<p>一般的な設定ではsudo実行すると、ユーザの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>はrootユーザへ引き継がれず、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>_AUTH_SOCKがないことがわかる。<br>
sudo後に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>がどうなっているか確認してみる。</p>

<pre><code>[vagrant@testsv ~]$ sudo env | grep -i ssh
　(なにも表示されない) 

</code></pre>

<p><br>
sudo実行しても、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>_AUTH_SOCKを引き継ぎたい！<br>
実はsudoで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>を引き継ぐ方法がある。-Eのオプションを付けると<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>を引き継ぐことが可能だ。<br>
以下のように<code>sudo -E</code>とすると...</p>

<pre><code>[vagrant@testsv ~]$ sudo -E env | grep -i ssh
SSH_CLIENT=192.168.33.100 60051 22
SSH_TTY=/dev/pts/1
SSH_AUTH_SOCK=/tmp/ssh-qhGLsXBURp/agent.9113
SSH_CONNECTION=192.168.33.100 60051 192.168.33.100 22 
</code></pre>

<p><br>
<code>sudo -E</code>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>が引き継げ、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>_AUTH_SOCKが引き継げるので、-Eをつけてsudo git cloneをトライする。</p>

<pre><code>[vagrant@testsv ~]$ sudo -E git clone git@xxxxx.xxx:yyyy/zzzzzz.git /root/hoge
Cloning into 'zzzzzz'...
remote: Counting objects: 27, done.
remote: Compressing objects: 100% (26/26), done.
remote: Total 27 (delta 13), reused 0 (delta 0)
Receiving objects: 100% (27/27), done.
Resolving deltas: 100% (13/13), done.
Checking connectivity... done. 

</code></pre>

<p>予想通り成功しました！</p>

<h3>(余談) suもsudoと同じ考え方ができる</h3>

<p>sudoだけではなくsuでのユーザ切り替えについても同じことが言える。<br>
rootユーザへ切り替えるとき、よく<code>su -</code>とハイフンをつけると思う。<br>
ハイフンをつけると、ログインシェルを使用してユーザを切り替えるので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>の引き継ぎは行われない。</p>

<h1>4. rootユーザでない他のユーザでgit cloneする</h1>

<p>続いて、rootユーザではない別の一般ユーザでのgit cloneについて考える。<br>
rootユーザの時と同じ要領で、sudoコマンドを利用しotheruserという別のユーザでgit cloneをしてみる。</p>

<p>まずは、sudoコマンドでは-uでユーザの指定ができるので、otheruserに切り替えた際の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>をみてみる。</p>

<pre><code>[vagrant@testsv ~]$ sudo -E -u otheruser env | grep -i ssh
SSH_CLIENT=192.168.33.100 60051 22
SSH_TTY=/dev/pts/1
SSH_AUTH_SOCK=/tmp/ssh-qhGLsXBURp/agent.9113
SSH_CONNECTION=192.168.33.100 60051 192.168.33.100 22 
</code></pre>

<p><br>
rootの時と同様で予想通りな感じ。
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>_AUTH_SOCKも引き継げているし、git clone可能だと思い以下を実行すると。</p>

<pre><code>$ sudo -E -u otheruser git clone git@xxxxx.xxx:yyyy/zzzzzz.git /home/otheruser
Permission denied (publickey).
fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists. 

</code></pre>

<p><br>
rootユーザの時とは異なってgit cloneは不可…</p>

<p>でも理由はいたって簡単。<br>
/tmp以下に保存されている認証情報は、所有者は接続したユーザで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%DF%A5%C3%A5%B7%A5%E7%A5%F3">パーミッション</a>は600なのだ。<br>
つまり、otheruserではこの認証情報は読みこめないのである。</p>

<pre><code>[vagrant@testsv ~]$ ls -l /tmp | grep ssh
drwx------. 2 vagrant    vagrant    23  4月  4 11:35 ssh-skQVHsUCHU 
</code></pre>

<p>重要な情報なので、アクセス権は妥当ですよね。<br>
試しにアクセス権を変えてみるとgit cloneは可能だ。</p>

<pre><code>[vagrant@testsv ~]$ chmod -R 777 /tmp/ssh-skQVHsUCHU
[vagrant@testsv ~]$ sudo -E -u otheruser git clone git@xxxxx.xxx:yyyy/zzzzzz.git /home/otheruser
Cloning into 'zzzzzz'...
remote: Counting objects: 27, done.
remote: Compressing objects: 100% (26/26), done.
remote: Total 27 (delta 13), reused 0 (delta 0)
Receiving objects: 100% (27/27), done.
Resolving deltas: 100% (13/13), done.
Checking connectivity... done. 
</code></pre>

<h1>5. まとめ</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のエージェントフォワードした際の動きと、重要な観点については抑えられた。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>エージェントフォワードの仕組みを見ていくことで、<br>
うかつにエージェントフォワードは利用してはいけない理由も見えてきた。</p>

<p><p>また、本題の「<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>エージェントフォワード後に、接続したユーザとは別のユーザでgit cloneしたい」だが、
そもそもそういうことをすることはNGということらしい。<br>
別のもっと賢い方法を考えろってことのようでした。</p>
</body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">22 Feb 2015, 21:13</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.mosuke.tech/entry/2015/02/22/211316/" class="post-title">Ruby, thin(bundler利用)を使った環境でのアプリの自動起動設定</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Linux" href="https://blog.mosuke.tech/categories/linux">Linux</a><a class="post-category post-category-init" href="https://blog.mosuke.tech/categories/init">init</a><a class="post-category post-category-自動起動" href="https://blog.mosuke.tech/categories/%E8%87%AA%E5%8B%95%E8%B5%B7%E5%8B%95">自動起動</a><a class="post-category post-category-Ruby" href="https://blog.mosuke.tech/categories/ruby">Ruby</a><a class="post-category post-category-thin" href="https://blog.mosuke.tech/categories/thin">thin</a><a class="post-category post-category-unicorn" href="https://blog.mosuke.tech/categories/unicorn">unicorn</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p>bunlderを使ったWebアプリをプロダクション環境で動かすときに、アプリの起動をどうやって実現しているだろうか。</p></p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a> Passengerを使う場合には、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の起動がアプリの起動につながるので、
アプリの起動はあまり気にしなかったかもしれない。</p>

<p>しかし、例えばNginx × <a class="keyword" href="http://d.hatena.ne.jp/keyword/Unicorn">Unicorn</a>/thinの構成などの場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Unicorn">Unicorn</a>やthinの起動もしなければいけなくなってくる。<br>
（あるいはこのようなケースがあるかは謎だが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Unicorn">Unicorn</a>やthinを単体で動かそうとしている場合など）</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Unicorn">Unicorn</a>やthin（例ではthinを扱うが本質は同じ）の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BC%AB%C6%B0%B5%AF%C6%B0">自動起動</a>を実現する際の勘所、注意事項をまとめた。</p>

<h1>0. 前提</h1>

<ul>
<li>CentOS6.5上で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a>でのWebアプリケーションを作っている。</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3%A5%B5%A1%BC%A5%D0">アプリケーションサーバ</a>はthinを利用している。</li>
<li>また、gemパッケージ管理にbundlerを利用している。</li>
</ul>

<h1>1. 開発環境でよくするアプリの起動</h1>

<p>開発環境では、アプリケーションのログの閲覧性なども兼ねて以下のようにアプリを起動していた。</p>

<pre><code>$ bundle exec rackup
$ bundle exec thin start 

</code></pre>

<p>でも、これではいつまでたってもプロダクション環境での利用はできません。</p>

<h1>2. 上記方法ではプロダクション環境で利用できない理由</h1>

<p>当然のことながら、プロダクション環境ではいちいち手動でコマンドを実行しアプリケーションを立ち上げるわけにはいかない。<br>
例えば、なんらかの理由でサーバが再起動してしまった場合には、<br>
このままではアプリケーションが自動的に立ち上がらないため、サービスの停止につながってしまう。</p>

<p>ではどうするのか？<br>
以下の状態であることがプロダクション環境では理想なのではないだろうか？</p>

<ul>
<li>オリジナルアプリケーションもserviceコマンドで起動・停止ができる

<ul>
<li>他のサービスと同様の操作方法が可能なのでわかりやすい</li>
</ul>
</li>
<li>サーバ立ち上げ時にサービスが自動で起動される</li>
</ul>

<h1>3. 起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を作ろう</h1>

<p>上記の状態にもっていくためには、起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を作らなければならない。</p>

<p>起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を作る…！？<br>
「作ったことないし、すぐには作れないよ〜」って思うかもしれないが、<br>
サンプルはたくさんあるし、よく見てみるとそれほど難しくはない。</p>

<p>thinを使ったサンプルを探そうと思うと数は少ないが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Unicorn">Unicorn</a>も同じ仕組なので、
"<a class="keyword" href="http://d.hatena.ne.jp/keyword/unicorn">unicorn</a> init script"なんて検索をかけてもいろいろでてくるのでおすすめ。</p>

<p>参考ししたもの<br>
<a href="https://gist.github.com/sbeam/3454488">https://gist.github.com/sbeam/3454488</a></p>

<p>上を参考にしながら、こんな起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を作ってみた。（未完成版）<br>
これを<code>/etc/init.d</code>以下へ配置する。</p>

<pre><code class="language-sh">#!/bin/bash

### BEGIN CHKCONFIG INFO
# chkconfig: 2345 55 25
# description: sample-app
### END CHKCONFIG INFO

SCRIPT_NAME=/etc/init.d/sample-app
CONFIG_PATH=/path/to/config
BUNDLE_CMD=/usr/local/bin/bundle

bundle_exec_thin ()
{
    for CONFIG_FILE in &quot;$CONFIG_PATH/*.yml&quot;; do
        SITE_DIR=`awk '/^chdir:/ { print $2; }' $CONFIG_FILE`
        cd $SITE_DIR
        $BUNDLE_CMD exec thin $1 -C $CONFIG_FILE
    done
}


case &quot;$1&quot; in
  start)
        bundle_exec_thin start
        ;;
  stop)
        bundle_exec_thin stop
        ;;
  restart)
        bundle_exec_thin restart
        ;;
  *)
        echo &quot;Usage: $SCRIPT_NAME {start|stop|restart}&quot; &gt;&amp;2
        exit 3
        ;;
esac

:
 
</code></pre>

<p>起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>も完成したし、実際にserviceコマンドで実行してみる。</p>

<pre><code>$ sudo service sample-app start
/usr/bin/env: ruby: No such file or directory 

</code></pre>

<p>んん。。。起動せず、撃沈…</p>

<h3>起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を作る上での注意</h3>

<p>起動しなかった原因に移る前に、起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を作る上での注意点を１つ。<br>
chkconfigで認識させるためには冒頭のCHKCONFIG INFO部分(<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%E1%A5%F3%A5%C8%A5%A2%A5%A6%A5%C8">コメントアウト</a>部分)も重要になってくる。<br>
CHKCONFIG INFO部分を書かないままchkconfigでaddしようとすると以下のように怒られます。</p>

<pre><code>$ sudo chkconfig --add sample-app
service sample-app does not support chkconfig 
</code></pre>

<h1>4. serviceコマンド実行時のPATHのはなし</h1>

<p>なぜ、serviceコマンドでthinを起動できなかったのか。<br>
調べていくと意外なことがわかった。<br>
serviceコマンドを実行すると中で<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>のPATHが上書きされてしまう。</p>

<p>【参照】<br>
<a href="http://heartbeats.jp/hbblog/2013/06/service-start-stop.html">デーモンの起動・終了にはserviceコマンドを利用しよう - インフラエンジニアway - Powered by HEARTBEATS</a></p>

<p>試しに、起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>内にPATHの出力を仕込んで確かめてみる。<br>
起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>に<code>echo $PATH</code>を仕込んだ。</p>

<pre><code>$ sudo service sample-app start
/sbin:/usr/sbin:/bin:/usr/bin 

</code></pre>

<p>起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>内でbundleや<a class="keyword" href="http://d.hatena.ne.jp/keyword/ruby">ruby</a>がインストールされているディレクトリに<br>
PATHを通すことで、解決することにした。<br>
（もっと美しい方法があれば教えて下さい。。。）</p>

<h1>5. 起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>修正(完成版)</h1>

<p>上記の通り起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を修正したものが以下。</p>

<pre><code class="language-sh">#!/bin/bash

### BEGIN CHKCONFIG INFO
# chkconfig: 2345 55 25
# description: sample-app
### END CHKCONFIG INFO

# 以下を追加
export PATH=/usr/local/bin:$PATH

SCRIPT_NAME=/etc/init.d/sample-app
CONFIG_PATH=/path/to/config
BUNDLE_CMD=/usr/local/bin/bundle

bundle_exec_thin ()
{
    for CONFIG_FILE in &quot;$CONFIG_PATH/*.yml&quot;; do
        SITE_DIR=`awk '/^chdir:/ { print $2; }' $CONFIG_FILE`
        cd $SITE_DIR
        $BUNDLE_CMD exec thin $1 -C $CONFIG_FILE
    done
}


case &quot;$1&quot; in
  start)
        bundle_exec_thin start
        ;;
  stop)
        bundle_exec_thin stop
        ;;
  restart)
        bundle_exec_thin restart
        ;;
  *)
        echo &quot;Usage: $SCRIPT_NAME {start|stop|restart}&quot; &gt;&amp;2
        exit 3
        ;;
esac

:
 
</code></pre>

<p>(PATHを通したのでbundleコマンドはフルパスでなくても大丈夫ですよ...)</p>

<p>最後に起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を<code>/etc/init.d</code>以下に配置し、
忘れずにchkconfigに登録しましょう。</p>

<pre><code>$ sudo chkconfig --add sample-app 

</code></pre>

<h1>【おまけ】sudo だと<a class="keyword" href="http://d.hatena.ne.jp/keyword/ruby">ruby</a>やgem、bundleが使えない？</h1>

<p>rootユーザでは<a class="keyword" href="http://d.hatena.ne.jp/keyword/ruby">ruby</a>やgem, bundleが使えるけど、sudoで実行すると使えない…<br>
という悩みの人も多いのではないだろうか。</p>

<pre><code>$ sudo gem install xxxxx
sudo: gem: command not found 
</code></pre>

<p><p>sudoでの実行はrootユーザで実行することなのになぜ実行できないか。<br>
これはsudoを使うときに/usr/local/binが許可されていないからだ。<br>
visudoでsecure_pathの設定を見直すとよい。<br>
<a href="http://www.xmisao.com/2013/10/11/sudoers-secure_path.html">sudoersのsecure_pathについて &ndash; ぺけみさお</a></p>
</body></p>

                    </div>
                </section>
                
                
            </div>
            
<div class="pagination">
  <nav role="pagination" class="post-list-pagination">
      
      <a href="/page/3/" class="post-list-pagination-item pure-button post-list-pagination-item-prev">
        <i class="fa fa-angle-double-left"></i>&nbsp;Newer
      </a>
      
    <span class="post-list-pagination-item post-list-pagination-item-current">Page 4 of 8</span>
    
      <a href="/page/5/" class="post-list-pagination-item pure-button post-list-pagination-item-next">
        Older&nbsp;<i class="fa fa-angle-double-right"></i>
      </a>
    
  </nav>
</div>


            <hr class="footer-hr" />
<div class="">
    <div class="google-search-engine">
        <script>
          (function() {
            var cx = '012458736543810277235:x4juxtghjhg';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
        </script>
		    <gcse:search></gcse:search>
    </div>
    <a class="pure-button" href="https://mosuke.tech "><i class="fa fa-user"></i> mosuke5</a>
    <a class="pure-button" href="/archive/"><i class="fa fa-archive"></i> Arvhive</a>
    <a class="pure-button" href="https://blog.mosuke.tech/index.xml"><i class="fa fa-rss"></i> rss</a>
</div>
<div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>&copy; <strong>mosuke5</strong> All rights reserved.<br />Powered by <a class="hugo" href="https://gohugo.io/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="https://blog.mosuke.tech/js/all.min.js"></script>

        </div>
    </div>
</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-99596316-1', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
